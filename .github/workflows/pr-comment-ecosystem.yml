# This is done in a separate workflow because pull_request workflow cannot write comments from forks.
# This is inspired from various pr-comment jobs in the ruff repo https://github.com/astral-sh/ruff/tree/main/.github/workflows
# See also https://github.com/peter-evans/create-pull-request/blob/main/docs/concepts-guidelines.md#restrictions-on-repository-forks
name: Ecosystem Check PR comment

on: # zizmor: ignore[dangerous-triggers] # We mitigate potential issues in `Skip symlinks` step
  workflow_run:
    workflows: [CI]
    types: [completed]
  workflow_dispatch:
    inputs:
      workflow_run_id:
        description: The CI workflow that triggers the workflow run
        required: true

# Cancel running jobs for the same workflow and branch.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  comment:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: dawidd6/action-download-artifact@ac66b43f0e6a346234dd65d4d0c8fbb31cb316e5 # v11
        name: Download pull request number
        with:
          name: pr-number
          run_id: ${{ github.event.workflow_run.id ||  github.event.inputs.workflow_run_id }}
          if_no_artifact_found: ignore
          allow_forks: true

      - name: Parse pull request number
        id: pr-number
        run: |
          if [[ -f pr-number ]]
          then
            echo "pr-number=$(<pr-number)" >> "$GITHUB_OUTPUT"
          fi

      - uses: dawidd6/action-download-artifact@ac66b43f0e6a346234dd65d4d0c8fbb31cb316e5 # v11
        name: "Download ecosystem check results"
        id: download-ecosystem-result
        if: steps.pr-number.outputs.pr-number
        with:
          name: ecosystem-result
          workflow: ci.yml
          pr: ${{ steps.pr-number.outputs.pr-number }}
          workflow_conclusion: completed
          if_no_artifact_found: ignore
          allow_forks: true

      - name: Skip symlinks
        id: skip-symlink
        if: steps.download-ecosystem-result.outputs.found_artifact == 'true'
        run: |
          # Guard against malicious ecosystem results that symlink to a secret
          # file on this runner
          if [[ -L full-comment.txt ]]
          then
              echo "Error: full-comment.txt cannot be a symlink"
              exit 1
          fi

      - name: Find existing comment
        uses: peter-evans/find-comment@b30e6a3c0ed37e7c023ccd3f1db5c6c0b0c23aad # v4.0.0
        if: steps.skip-symlink.outcome == 'success'
        id: find-comment
        with:
          issue-number: ${{ steps.pr-number.outputs.pr-number }}
          comment-author: "github-actions[bot]"
          body-includes: "<!-- generated-comment ecosystem -->"

      - name: Create or update comment
        if: steps.find-comment.outcome == 'success'
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ steps.pr-number.outputs.pr-number }}
          body-path: full-comment.txt
          edit-mode: replace
